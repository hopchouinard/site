---
/**
 * Source Archive - Meta index listing all published days
 * Route: /source
 */
import { readFile, readdir } from 'fs/promises';
import { join } from 'path';

// Load source manifest index
const manifestIndexPath = join(process.cwd(), 'src/data/source-manifest-index.json');

let manifestIndex = {};
try {
  const content = await readFile(manifestIndexPath, 'utf-8');
  manifestIndex = JSON.parse(content);
} catch (err) {
  console.warn('No source manifest index found');
}

// Sort dates in descending order (newest first)
const sortedDates = Object.keys(manifestIndex).sort((a, b) => b.localeCompare(a));

// Format file size
function formatBytes(bytes: number): string {
  if (bytes === 0) return '0 B';
  const k = 1024;
  const sizes = ['B', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return `${(bytes / Math.pow(k, i)).toFixed(1)} ${sizes[i]}`;
}

const title = 'Source Archive - NeuroHelix';
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{title}</title>
  <meta name="description" content="Browse all source artifacts from NeuroHelix daily research" />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
</head>
<body>
  <div class="source-archive">
    <!-- Header -->
    <header class="archive-header">
      <div class="archive-header__content">
        <div class="archive-header__brand">
          <a href="/" class="brand-link">
            <span class="brand-icon">ðŸ§¬</span>
            <span class="brand-name">NeuroHelix</span>
          </a>
          <span class="archive-header__divider">/</span>
          <h1 class="archive-header__title">Source Archive</h1>
        </div>

        <a href="/" class="action-button">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="m15 18-6-6 6-6"/>
          </svg>
          Back to Home
        </a>
      </div>
    </header>

    <!-- Main Content -->
    <main class="archive-main">
      <div class="archive-intro">
        <p class="archive-description">
          Browse raw research artifacts generated by NeuroHelix's daily AI research pipeline.
          Each day contains prompts, summaries, cross-analysis, and other intermediate outputs.
        </p>

        <div class="archive-stats">
          <div class="stat-card">
            <div class="stat-card__value">{sortedDates.length}</div>
            <div class="stat-card__label">Published Days</div>
          </div>
          <div class="stat-card">
            <div class="stat-card__value">
              {Object.values(manifestIndex).reduce((sum: number, m: any) => sum + m.artifactCount, 0)}
            </div>
            <div class="stat-card__label">Total Artifacts</div>
          </div>
          <div class="stat-card">
            <div class="stat-card__value">
              {formatBytes(Object.values(manifestIndex).reduce((sum: number, m: any) => sum + m.byteSize, 0))}
            </div>
            <div class="stat-card__label">Total Size</div>
          </div>
        </div>
      </div>

      {sortedDates.length === 0 ? (
        <div class="empty-state">
          <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
          </svg>
          <h2>No Source Artifacts Yet</h2>
          <p>Source artifacts will appear here once the pipeline has run.</p>
        </div>
      ) : (
        <div class="archive-list">
          {sortedDates.map((date) => {
            const manifest = manifestIndex[date];
            return (
              <article class="day-card">
                <div class="day-card__header">
                  <div class="day-card__info">
                    <h2 class="day-card__date">
                      <a href={`/daily/${date}/source/`}>{date}</a>
                    </h2>
                    <div class="day-card__meta">
                      <span class="meta-badge">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/>
                          <polyline points="13 2 13 9 20 9"/>
                        </svg>
                        {manifest.artifactCount} artifacts
                      </span>
                      <span class="meta-badge">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                        </svg>
                        {formatBytes(manifest.byteSize)}
                      </span>
                    </div>
                  </div>

                  <div class="day-card__actions">
                    <a href={`/daily/${date}/source/`} class="view-button view-button--source">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="16 18 22 12 16 6"/>
                        <polyline points="8 6 2 12 8 18"/>
                      </svg>
                      Source
                    </a>
                    <a href={`/daily/${date}`} class="view-button view-button--processed">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                      </svg>
                      Processed
                    </a>
                  </div>
                </div>

                {manifest.types && Object.keys(manifest.types).length > 0 && (
                  <div class="day-card__types">
                    {Object.entries(manifest.types).map(([type, count]: [string, any]) => (
                      <span class="type-chip">
                        {type.replace(/_/g, ' ')}: {count}
                      </span>
                    ))}
                  </div>
                )}
              </article>
            );
          })}
        </div>
      )}
    </main>
  </div>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0a0a0a;
      color: #fff;
    }

    .source-archive {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .archive-header {
      background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
      border-bottom: 1px solid rgba(139, 92, 246, 0.2);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
    }

    .archive-header__content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1.5rem 2rem;
      max-width: 1400px;
      margin: 0 auto;
    }

    .archive-header__brand {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .brand-link {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      text-decoration: none;
      color: #fff;
      font-weight: 600;
      font-size: 1.125rem;
      transition: color 0.2s ease;
    }

    .brand-link:hover {
      color: #8b5cf6;
    }

    .brand-icon {
      font-size: 1.5rem;
    }

    .archive-header__divider {
      color: rgba(255, 255, 255, 0.3);
      font-weight: 300;
    }

    .archive-header__title {
      font-size: 1.25rem;
      font-weight: 600;
      color: #fff;
    }

    .action-button {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.625rem 1.25rem;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 0.5rem;
      color: #fff;
      text-decoration: none;
      font-size: 0.875rem;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .action-button:hover {
      background: rgba(139, 92, 246, 0.2);
      border-color: #8b5cf6;
    }

    .archive-main {
      flex: 1;
      max-width: 1400px;
      margin: 0 auto;
      padding: 3rem 2rem;
      width: 100%;
    }

    .archive-intro {
      margin-bottom: 3rem;
    }

    .archive-description {
      font-size: 1.125rem;
      line-height: 1.7;
      color: rgba(255, 255, 255, 0.8);
      margin-bottom: 2rem;
    }

    .archive-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 0.75rem;
      padding: 1.5rem;
      text-align: center;
    }

    .stat-card__value {
      font-size: 2.5rem;
      font-weight: 700;
      color: #8b5cf6;
      margin-bottom: 0.5rem;
      font-variant-numeric: tabular-nums;
    }

    .stat-card__label {
      font-size: 0.875rem;
      color: rgba(255, 255, 255, 0.6);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .archive-list {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .day-card {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 0.75rem;
      padding: 1.5rem;
      transition: all 0.2s ease;
    }

    .day-card:hover {
      background: rgba(255, 255, 255, 0.05);
      border-color: rgba(139, 92, 246, 0.3);
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.1);
    }

    .day-card__header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1.5rem;
      margin-bottom: 1rem;
    }

    .day-card__info {
      flex: 1;
    }

    .day-card__date {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      font-family: ui-monospace, monospace;
    }

    .day-card__date a {
      color: #fff;
      text-decoration: none;
      transition: color 0.2s ease;
    }

    .day-card__date a:hover {
      color: #8b5cf6;
    }

    .day-card__meta {
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .meta-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      font-size: 0.875rem;
      color: rgba(255, 255, 255, 0.7);
      font-family: ui-monospace, monospace;
    }

    .day-card__actions {
      display: flex;
      gap: 0.75rem;
    }

    .view-button {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.625rem 1rem;
      border-radius: 0.5rem;
      text-decoration: none;
      font-size: 0.875rem;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .view-button--source {
      background: rgba(139, 92, 246, 0.1);
      border: 1px solid rgba(139, 92, 246, 0.3);
      color: #c4b5fd;
    }

    .view-button--source:hover {
      background: rgba(139, 92, 246, 0.2);
      border-color: #8b5cf6;
      color: #fff;
    }

    .view-button--processed {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: rgba(255, 255, 255, 0.8);
    }

    .view-button--processed:hover {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
    }

    .day-card__types {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .type-chip {
      display: inline-block;
      padding: 0.25rem 0.625rem;
      background: rgba(59, 130, 246, 0.1);
      border-radius: 0.375rem;
      font-size: 0.75rem;
      color: #93c5fd;
      text-transform: capitalize;
      font-family: ui-monospace, monospace;
    }

    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 4rem 2rem;
      text-align: center;
      color: rgba(255, 255, 255, 0.6);
    }

    .empty-state svg {
      margin-bottom: 1.5rem;
      opacity: 0.5;
    }

    .empty-state h2 {
      margin-bottom: 0.5rem;
      font-size: 1.5rem;
      color: #fff;
    }

    @media (max-width: 768px) {
      .archive-header__content {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
      }

      .day-card__header {
        flex-direction: column;
        align-items: flex-start;
      }

      .day-card__actions {
        width: 100%;
      }

      .view-button {
        flex: 1;
        justify-content: center;
      }
    }
  </style>
</body>
</html>

---
import BaseLayout from '../layouts/BaseLayout.astro';
import HeroSection from '../components/HeroSection.astro';
import SearchBar from '../components/SearchBar.astro';
import CategoryFilters from '../components/CategoryFilters.astro';
import TagCloud from '../components/TagCloud.astro';
import DashboardCard from '../components/DashboardCard.astro';
import { getCollection } from 'astro:content';

// Import data files
import tagFrequencies from '../data/tag-frequencies.json';
import categoryMapping from '../data/categories.json';
import stats from '../data/stats.json';

// Get and sort dashboards
const allDashboards = await getCollection('dashboards');
const sortedDashboards = allDashboards.sort((a, b) => b.data.date.localeCompare(a.data.date));

// Get latest dashboard for hero CTA
const latestDashboard = sortedDashboards[0];

// Prepare categories for filters
// Use the actual category name as ID to match dashboard categories
const categoryFilters = Object.keys(categoryMapping).map(cat => ({
  id: cat, // Use full name, not slug
  label: cat,
  icon: getCategoryIcon(cat),
  selected: false
}));

function getCategoryIcon(category: string): string {
  const icons = {
    'AI Trends': 'ðŸ¤–',
    'Market Analysis': 'ðŸ“Š',
    'Regulation': 'âš–ï¸',
    'Strategy': 'ðŸŽ¯',
    'Tooling': 'ðŸ”§'
  };
  return icons[category] || 'ðŸ“Œ';
}

// Prepare tags with frequency data
const tags = tagFrequencies.map(tag => ({
  ...tag,
  selected: false
}));

// Prepare dashboards data for client-side filtering
const dashboardsData = sortedDashboards.map(d => ({
  date: d.data.date,
  title: d.data.title,
  summary: d.data.summary,
  tags: d.data.tags || [],
  categories: d.data.categories || [],
  url: `/dashboards/${d.data.date}/`
}));
---

<BaseLayout title="NeuroHelix - AI Research Intelligence">
  {latestDashboard && (
    <HeroSection
      headline="NeuroHelix"
      subcopy="AI-powered research automation delivering daily insights across domains. Discover patterns, track developments, and stay ahead of the curve."
      ctaLabel="View Latest Report"
      ctaHref={`/dashboards/${latestDashboard.data.date}/`}
      stats={[
        { label: 'Days Published', value: stats.daysPublished.toString() },
        { label: 'Total Reports', value: stats.totalDashboards.toString() },
        { label: 'Insights Generated', value: stats.totalInsights.toString() }
      ]}
    />
  )}
  
  <div class="container">
    <SearchBar placeholder="Search dashboardsâ€¦" />
    
    <CategoryFilters categories={categoryFilters} />
    
    <!-- Active filters bar with clear button -->
    <div id="active-filters-bar" class="active-filters-bar" style="display: none;">
      <div class="active-filters-info">
        <span id="active-filters-text"></span>
      </div>
      <button id="clear-all-filters" class="clear-all-btn">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true">
          <path d="M12 4L4 12M4 4l8 8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        Clear all filters
      </button>
    </div>
    
    <div class="content-layout">
      <div class="main-content">
        <div class="dashboard-controls">
          <div class="results-info">
            <span id="result-count">{sortedDashboards.length} report{sortedDashboards.length !== 1 ? 's' : ''}</span>
          </div>
          <div class="sort-controls">
            <label for="sort-select">Sort by:</label>
            <select id="sort-select">
              <option value="date-desc">Newest â†’ Oldest</option>
              <option value="date-asc">Oldest â†’ Newest</option>
            </select>
          </div>
        </div>
        
        <div id="dashboard-grid" class="dashboard-grid">
          {sortedDashboards.map((dashboard) => (
            <DashboardCard
              date={dashboard.data.date}
              title={dashboard.data.title}
              summary={dashboard.data.summary}
              tags={dashboard.data.tags || []}
              categories={dashboard.data.categories || []}
              url={`/dashboards/${dashboard.data.date}/`}
            />
          ))}
        </div>
        
        <div id="empty-state" class="empty-state" style="display: none;">
          <p>No dashboards match your filters.</p>
          <button id="reset-filters" class="reset-btn">Reset all filters</button>
        </div>
      </div>
      
      <aside class="sidebar">
        <TagCloud tags={tags} />
      </aside>
    </div>
  </div>
</BaseLayout>

<script>
  import { FilterStateManager } from '../scripts/filterState';
  import type { Dashboard } from '../scripts/filterState';
  import { initializeSearch, performSearch, isSearchAvailable } from '../scripts/searchManager';
  
  // Initialize filter state
  const dashboards: Dashboard[] = JSON.parse(document.getElementById('dashboards-data')?.textContent || '[]');
  const filterManager = new FilterStateManager(dashboards);
  
  // Initialize search on page load
  let searchInitialized = false;
  initializeSearch().then(success => {
    searchInitialized = success;
    if (!success) {
      console.warn('Search functionality unavailable, falling back to simple text matching');
    }
  }).catch(err => {
    console.error('Search initialization error:', err);
  });
  
  // Subscribe to state changes
  filterManager.subscribe(() => {
    updateUI();
  });
  
  // Event listeners
  window.addEventListener('tag-filter-change', ((e: CustomEvent) => {
    filterManager.toggleTag(e.detail.tag);
  }) as EventListener);
  
  window.addEventListener('category-filter-change', ((e: CustomEvent) => {
    filterManager.toggleCategory(e.detail.category);
  }) as EventListener);
  
  window.addEventListener('search-query-change', ((e: CustomEvent) => {
    const query = e.detail.query;
    
    // Perform MiniSearch if available
    let searchResultIds: string[] | null = null;
    if (searchInitialized && query && query.trim().length > 0) {
      searchResultIds = performSearch(query);
    }
    
    filterManager.setSearchQuery(query, searchResultIds);
  }) as EventListener);
  
  window.addEventListener('clear-tag-filters', () => {
    filterManager.clearTagFilters();
  });
  
  // Handle both reset buttons (empty state and active filters bar)
  document.getElementById('reset-filters')?.addEventListener('click', () => {
    clearAllFilters();
  });
  
  document.getElementById('clear-all-filters')?.addEventListener('click', () => {
    clearAllFilters();
  });
  
  function clearAllFilters() {
    filterManager.clearAllFilters();
    const searchInput = document.getElementById('dashboard-search') as HTMLInputElement;
    if (searchInput) searchInput.value = '';
    
    // Reset tag visual states
    document.querySelectorAll('.tag').forEach(tag => {
      tag.classList.remove('active');
      tag.setAttribute('aria-pressed', 'false');
    });
    
    // Reset category visual states
    document.querySelectorAll('.category-pill').forEach(pill => {
      pill.classList.remove('active');
      pill.setAttribute('aria-checked', 'false');
    });
  }
  
  function updateUI() {
    const filtered = filterManager.getFilteredDashboards();
    const state = filterManager.getState();
    const grid = document.getElementById('dashboard-grid');
    const emptyState = document.getElementById('empty-state');
    const resultCount = document.getElementById('result-count');
    const resultsCountDiv = document.getElementById('search-results-count');
    const activeFiltersBar = document.getElementById('active-filters-bar');
    const activeFiltersText = document.getElementById('active-filters-text');
    
    // Update result count
    if (resultCount) {
      resultCount.textContent = `${filtered.length} report${filtered.length !== 1 ? 's' : ''}`;
    }
    
    // Update search results count
    if (resultsCountDiv) {
      const activeFilters = state.selectedTags.size + state.selectedCategories.size + (state.searchQuery ? 1 : 0);
      if (activeFilters > 0) {
        resultsCountDiv.textContent = `Showing ${filtered.length} of ${state.allDashboards.length} reports`;
      } else {
        resultsCountDiv.textContent = '';
      }
    }
    
    // Show/hide active filters bar
    const totalActiveFilters = state.selectedTags.size + state.selectedCategories.size + (state.searchQuery ? 1 : 0);
    if (activeFiltersBar && activeFiltersText) {
      if (totalActiveFilters > 0) {
        activeFiltersBar.style.display = 'flex';
        const filterParts = [];
        if (state.searchQuery) filterParts.push('search');
        if (state.selectedTags.size > 0) filterParts.push(`${state.selectedTags.size} tag${state.selectedTags.size > 1 ? 's' : ''}`);
        if (state.selectedCategories.size > 0) filterParts.push(`${state.selectedCategories.size} categor${state.selectedCategories.size > 1 ? 'ies' : 'y'}`);
        activeFiltersText.textContent = `Active filters: ${filterParts.join(', ')}`;
      } else {
        activeFiltersBar.style.display = 'none';
      }
    }
    
    // Update tag visual states
    document.querySelectorAll('.tag').forEach(tag => {
      const tagName = (tag as HTMLElement).dataset.tag;
      if (tagName && state.selectedTags.has(tagName)) {
        tag.classList.add('active');
        tag.setAttribute('aria-pressed', 'true');
      } else {
        tag.classList.remove('active');
        tag.setAttribute('aria-pressed', 'false');
      }
    });
    
    // Update category visual states
    document.querySelectorAll('.category-pill').forEach(pill => {
      const categoryId = (pill as HTMLElement).dataset.category;
      if (categoryId && state.selectedCategories.has(categoryId)) {
        pill.classList.add('active');
        pill.setAttribute('aria-checked', 'true');
      } else {
        pill.classList.remove('active');
        pill.setAttribute('aria-checked', 'false');
      }
    });
    
    // Show/hide empty state
    if (filtered.length === 0) {
      if (grid) grid.style.display = 'none';
      if (emptyState) emptyState.style.display = 'block';
    } else {
      if (grid) grid.style.display = 'grid';
      if (emptyState) emptyState.style.display = 'none';
      
      // Show/hide cards based on filtered results
      updateCardVisibility(filtered);
    }
  }
  
  /**
   * Update card visibility with smooth transitions
   * Uses Set for O(1) lookup performance
   */
  function updateCardVisibility(filteredDashboards: Dashboard[]) {
    // Create a Set of filtered dashboard dates for O(1) lookup
    const filteredDates = new Set(filteredDashboards.map(d => d.date));
    
    // Get all dashboard cards
    const cards = document.querySelectorAll('[data-dashboard-id]');
    
    // Use requestAnimationFrame for smooth updates
    requestAnimationFrame(() => {
      cards.forEach((card) => {
        const cardDate = (card as HTMLElement).dataset.dashboardId;
        
        if (!cardDate) return;
        
        // Show card if it's in filtered results, hide otherwise
        if (filteredDates.has(cardDate)) {
          card.classList.remove('hidden');
          (card as HTMLElement).style.display = '';
        } else {
          card.classList.add('hidden');
          // Use setTimeout to allow transition to complete before display:none
          setTimeout(() => {
            if (card.classList.contains('hidden')) {
              (card as HTMLElement).style.display = 'none';
            }
          }, 200); // Match transition duration
        }
      });
    });
  }
</script>

<!-- Embed dashboards data for client-side filtering -->
<script id="dashboards-data" type="application/json" set:html={JSON.stringify(dashboardsData)}></script>

<style>
  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 var(--space-4);
  }
  
  .content-layout {
    display: grid;
    gap: var(--space-8);
    grid-template-columns: 1fr;
    margin-top: var(--space-8);
  }
  
  @media (min-width: 1024px) {
    .content-layout {
      grid-template-columns: 1fr 300px;
    }
  }
  
  .dashboard-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-6);
    flex-wrap: wrap;
    gap: var(--space-4);
  }
  
  .results-info {
    font-size: 0.875rem;
    color: var(--color-text-muted);
  }
  
  .sort-controls {
    display: flex;
    align-items: center;
    gap: var(--space-2);
  }
  
  .sort-controls label {
    font-size: 0.875rem;
    color: var(--color-text-muted);
  }
  
  .sort-controls select {
    padding: var(--space-2) var(--space-3);
    background: var(--color-surface);
    border: 1px solid rgba(139, 92, 246, 0.2);
    border-radius: var(--radius-sm);
    color: var(--color-text-primary);
    cursor: pointer;
  }
  
  .dashboard-grid {
    display: grid;
    gap: var(--space-6);
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  }
  
  .empty-state {
    text-align: center;
    padding: var(--space-12);
    color: var(--color-text-muted);
  }
  
  .reset-btn {
    margin-top: var(--space-4);
    padding: var(--space-3) var(--space-6);
    background: var(--color-accent);
    color: white;
    border: none;
    border-radius: var(--radius-md);
    cursor: pointer;
    font-weight: 500;
  }
  
  .reset-btn:hover {
    background: rgba(139, 92, 246, 0.8);
  }
  
  .sidebar {
    position: relative;
  }
  
  @media (max-width: 1023px) {
    .sidebar {
      order: -1;
    }
  }
  
  /* Active filters bar */
  .active-filters-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-4);
    padding: var(--space-4) var(--space-6);
    background: rgba(139, 92, 246, 0.1);
    border: 1px solid rgba(139, 92, 246, 0.3);
    border-radius: var(--radius-md);
    margin: var(--space-6) 0;
  }
  
  .active-filters-info {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--text-sm);
    color: var(--color-text-primary);
  }
  
  .clear-all-btn {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-4);
    background: var(--color-accent);
    color: white;
    border: none;
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-size: var(--text-sm);
    font-weight: 500;
    transition: all var(--transition-fast);
    white-space: nowrap;
  }
  
  .clear-all-btn:hover {
    background: rgba(139, 92, 246, 0.8);
    transform: translateY(-1px);
  }
  
  .clear-all-btn:active {
    transform: translateY(0);
  }
  
  @media (max-width: 640px) {
    .active-filters-bar {
      flex-direction: column;
      align-items: stretch;
    }
    
    .clear-all-btn {
      justify-content: center;
    }
  }
</style>

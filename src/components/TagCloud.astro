---
interface Tag {
  name: string;
  count: number;
  selected: boolean;
}

interface Props {
  tags: Tag[];
}

const { tags } = Astro.props;

// Calculate weighted font sizes (min 0.875rem, max 1.5rem)
const maxCount = Math.max(...tags.map(t => t.count), 1);
const minCount = Math.min(...tags.map(t => t.count), 1);
const getFontSize = (count: number) => {
  if (maxCount === minCount) return '1rem';
  const ratio = (count - minCount) / (maxCount - minCount);
  const size = 0.875 + (ratio * 0.625); // 0.875 to 1.5rem
  return `${size}rem`;
};
---

<div class="tag-cloud">
  <h2>Browse by Tag</h2>
  <div class="tags-container" role="list">
    {tags.map(tag => (
      <button
        class={`tag ${tag.selected ? 'active' : ''}`}
        data-tag={tag.name}
        style={`font-size: ${getFontSize(tag.count)}`}
        role="listitem"
        aria-pressed={tag.selected}
      >
        {tag.name}
        <span class="tag-count">({tag.count})</span>
      </button>
    ))}
  </div>
  {tags.some(t => t.selected) && (
    <button class="clear-filters" id="clear-tag-filters">
      Clear tag filters
    </button>
  )}
</div>

<script>
  // Client-side interactivity
  document.addEventListener('DOMContentLoaded', () => {
    const tags = document.querySelectorAll('.tag');
    tags.forEach(tag => {
      tag.addEventListener('click', (e) => {
        const tagName = (e.currentTarget as HTMLElement).dataset.tag;
        // Dispatch custom event for filter state management
        window.dispatchEvent(new CustomEvent('tag-filter-change', {
          detail: { tag: tagName }
        }));
      });
      
      // Keyboard navigation
      tag.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          (e.currentTarget as HTMLElement).click();
        }
      });
    });
    
    const clearBtn = document.getElementById('clear-tag-filters');
    if (clearBtn) {
      clearBtn.addEventListener('click', () => {
        window.dispatchEvent(new CustomEvent('clear-tag-filters'));
      });
    }
  });
</script>

<style>
  .tag-cloud {
    margin: var(--space-8) 0;
  }
  
  .tag-cloud h2 {
    font-size: 1.25rem;
    margin-bottom: var(--space-4);
    color: var(--color-text-primary);
  }
  
  .tags-container {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
    margin: var(--space-4) 0;
  }
  
  .tag {
    background: var(--color-surface);
    border: 1px solid rgba(139, 92, 246, 0.2);
    border-radius: var(--radius-md);
    padding: var(--space-2) var(--space-3);
    cursor: pointer;
    transition: all 0.2s ease;
    color: var(--color-text-secondary);
  }
  
  .tag:hover {
    background: rgba(139, 92, 246, 0.1);
    border-color: var(--color-accent);
  }
  
  .tag.active {
    background: var(--color-accent);
    color: white;
    border-color: var(--color-accent);
  }
  
  .tag:focus-visible {
    outline: 2px solid var(--color-accent);
    outline-offset: 2px;
  }
  
  .tag-count {
    opacity: 0.7;
    font-size: 0.875em;
  }
  
  .clear-filters {
    margin-top: var(--space-4);
    padding: var(--space-2) var(--space-4);
    background: transparent;
    border: 1px solid var(--color-text-muted);
    border-radius: var(--radius-sm);
    color: var(--color-text-muted);
    cursor: pointer;
  }
  
  .clear-filters:hover {
    border-color: var(--color-accent);
    color: var(--color-accent);
  }
</style>

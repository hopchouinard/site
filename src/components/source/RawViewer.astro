---
/**
 * RawViewer component - Renders raw file content with appropriate syntax highlighting
 * Supports: Markdown, JSON, YAML, plain text, and binary files
 */
interface Props {
  content: string;
  mime: string;
  fileName: string;
  sizeBytes: number;
}

const { content, mime, fileName, sizeBytes } = Astro.props;

// Determine viewer type based on MIME
const isMarkdown = mime?.includes('markdown');
const isJSON = mime?.includes('json');
const isYAML = mime?.includes('yaml');
const isText = mime?.startsWith('text/') || isJSON || isYAML;
const isBinary = !isText;
const isLarge = sizeBytes > 2 * 1024 * 1024; // 2MB

// Get language for syntax highlighting
function getLanguage(mime: string, fileName: string): string {
  if (mime?.includes('markdown')) return 'markdown';
  if (mime?.includes('json')) return 'json';
  if (mime?.includes('yaml')) return 'yaml';
  if (mime?.includes('javascript')) return 'javascript';
  if (mime?.includes('typescript')) return 'typescript';
  if (mime?.includes('python')) return 'python';
  if (fileName?.endsWith('.sh')) return 'bash';
  if (fileName?.endsWith('.csv')) return 'csv';
  return 'text';
}

const language = getLanguage(mime, fileName);
---

<div class="raw-viewer" data-mime={mime} data-language={language}>
  {isLarge ? (
    <div class="raw-viewer__large-file">
      <div class="raw-viewer__large-file-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
          <polyline points="14 2 14 8 20 8"/>
        </svg>
      </div>
      <h3>Large File</h3>
      <p>This file is too large to display inline ({(sizeBytes / (1024 * 1024)).toFixed(1)} MB).</p>
      <p>Please use the download button above to view this file.</p>
    </div>
  ) : isBinary ? (
    <div class="raw-viewer__binary">
      <div class="raw-viewer__binary-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
          <line x1="3" y1="9" x2="21" y2="9"/>
          <line x1="9" y1="21" x2="9" y2="9"/>
        </svg>
      </div>
      <h3>Binary File</h3>
      <p>This file contains binary data and cannot be displayed as text.</p>
      <p>Please use the download button above to view this file.</p>
    </div>
  ) : isMarkdown ? (
    <div class="raw-viewer__markdown">
      <pre class="code-block"><code class="language-{language}">{content}</code></pre>
    </div>
  ) : isJSON ? (
    <div class="raw-viewer__json">
      <div class="raw-viewer__toolbar">
        <span class="raw-viewer__label">JSON Viewer</span>
        <button class="raw-viewer__format-btn" data-format="pretty">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="16 18 22 12 16 6"/>
            <polyline points="8 6 2 12 8 18"/>
          </svg>
          Format
        </button>
      </div>
      <pre class="code-block code-block--json"><code class="language-json">{content}</code></pre>
    </div>
  ) : (
    <div class="raw-viewer__text">
      <pre class="code-block"><code class="language-{language}">{content}</code></pre>
    </div>
  )}
</div>

<style>
  .raw-viewer {
    background: var(--color-surface, #1a1a1a);
    color: #fff;
    height: 100%;
    overflow: auto;
  }

  .raw-viewer__large-file,
  .raw-viewer__binary {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 4rem 2rem;
    text-align: center;
    color: rgba(255, 255, 255, 0.7);
  }

  .raw-viewer__large-file-icon,
  .raw-viewer__binary-icon {
    margin-bottom: 1.5rem;
    opacity: 0.5;
  }

  .raw-viewer__large-file h3,
  .raw-viewer__binary h3 {
    margin: 0 0 0.5rem;
    font-size: 1.25rem;
    font-weight: 600;
    color: #fff;
  }

  .raw-viewer__large-file p,
  .raw-viewer__binary p {
    margin: 0.25rem 0;
    font-size: 0.875rem;
  }

  .raw-viewer__toolbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    background: rgba(0, 0, 0, 0.2);
  }

  .raw-viewer__label {
    font-size: 0.875rem;
    font-weight: 500;
    color: rgba(255, 255, 255, 0.7);
  }

  .raw-viewer__format-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.375rem 0.75rem;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 0.375rem;
    color: #fff;
    font-size: 0.75rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: inherit;
  }

  .raw-viewer__format-btn:hover {
    background: rgba(139, 92, 246, 0.2);
    border-color: #8b5cf6;
  }

  .code-block {
    margin: 0;
    padding: 1.5rem;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 0.5rem;
    overflow-x: auto;
    font-family: 'Fira Code', ui-monospace, monospace;
    font-size: 0.875rem;
    line-height: 1.6;
  }

  .code-block code {
    display: block;
    color: #e5e7eb;
  }

  .code-block--json {
    background: rgba(0, 0, 0, 0.5);
  }

  .markdown-content {
    max-width: 72ch;
    margin: 0 auto;
    line-height: 1.7;
  }

  .markdown-content :global(h1),
  .markdown-content :global(h2),
  .markdown-content :global(h3) {
    margin-top: 1.5em;
    margin-bottom: 0.5em;
    font-weight: 600;
    color: #fff;
  }

  .markdown-content :global(p) {
    margin: 1em 0;
  }

  .markdown-content :global(a) {
    color: #8b5cf6;
    text-decoration: none;
  }

  .markdown-content :global(a:hover) {
    text-decoration: underline;
  }

  .markdown-content :global(code) {
    padding: 0.2em 0.4em;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 0.25rem;
    font-family: 'Fira Code', ui-monospace, monospace;
    font-size: 0.85em;
  }

  .markdown-content :global(pre) {
    margin: 1.5em 0;
    padding: 1rem;
    background: rgba(0, 0, 0, 0.5);
    border-radius: 0.5rem;
    overflow-x: auto;
  }

  .markdown-content :global(pre code) {
    padding: 0;
    background: none;
  }
</style>

<script>
  // JSON formatting button
  document.addEventListener('DOMContentLoaded', () => {
    const formatBtn = document.querySelector('.raw-viewer__format-btn');
    if (formatBtn) {
      formatBtn.addEventListener('click', () => {
        const codeBlock = document.querySelector('.code-block--json code');
        if (codeBlock) {
          try {
            const json = JSON.parse(codeBlock.textContent || '');
            codeBlock.textContent = JSON.stringify(json, null, 2);
          } catch (err) {
            console.error('Failed to format JSON:', err);
          }
        }
      });
    }
  });
</script>

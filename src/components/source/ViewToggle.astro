---
/**
 * ViewToggle component - Toggle between Processed and Source views
 * Supports keyboard shortcuts: Shift+P (processed), Shift+S (source)
 * Persists state to localStorage and syncs with query params
 */
interface Props {
  currentView: 'processed' | 'source';
  date: string;
}

const { currentView, date } = Astro.props;
---

<div class="view-toggle" data-current-view={currentView} data-date={date}>
  <button
    class="view-toggle__button"
    data-view="processed"
    aria-pressed={currentView === 'processed'}
  >
    <svg class="view-toggle__icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
      <polyline points="14 2 14 8 20 8"></polyline>
      <line x1="16" y1="13" x2="8" y2="13"></line>
      <line x1="16" y1="17" x2="8" y2="17"></line>
      <polyline points="10 9 9 9 8 9"></polyline>
    </svg>
    <span>Processed View</span>
    <kbd class="view-toggle__shortcut">⇧P</kbd>
  </button>

  <button
    class="view-toggle__button"
    data-view="source"
    aria-pressed={currentView === 'source'}
  >
    <svg class="view-toggle__icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <polyline points="16 18 22 12 16 6"></polyline>
      <polyline points="8 6 2 12 8 18"></polyline>
    </svg>
    <span>Source View</span>
    <kbd class="view-toggle__shortcut">⇧S</kbd>
  </button>
</div>

<style>
  .view-toggle {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 0.5rem;
    padding: 0.25rem;
  }

  .view-toggle__button {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    background: transparent;
    border: none;
    border-radius: 0.375rem;
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: inherit;
  }

  .view-toggle__button:hover {
    background: rgba(139, 92, 246, 0.2);
    color: #fff;
  }

  .view-toggle__button[aria-pressed="true"] {
    background: rgba(139, 92, 246, 0.3);
    color: #fff;
    box-shadow: 0 0 0 1px #8b5cf6 inset;
  }

  .view-toggle__icon {
    width: 1rem;
    height: 1rem;
    flex-shrink: 0;
  }

  .view-toggle__shortcut {
    display: none;
    font-size: 0.75rem;
    padding: 0.125rem 0.375rem;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 0.25rem;
    font-family: ui-monospace, monospace;
    opacity: 0.7;
  }

  @media (min-width: 768px) {
    .view-toggle__shortcut {
      display: inline-block;
    }
  }

  .view-toggle__button:focus-visible {
    outline: 2px solid #8b5cf6;
    outline-offset: 2px;
  }
</style>

<script>
  // Client-side view toggle logic
  class ViewToggleManager {
    private container: HTMLElement;
    private currentDate: string;
    private currentView: 'processed' | 'source';

    constructor(container: HTMLElement) {
      this.container = container;
      this.currentDate = container.dataset.date || '';
      this.currentView = (container.dataset.currentView as 'processed' | 'source') || 'processed';

      this.initialize();
    }

    private initialize() {
      // Handle button clicks
      const buttons = this.container.querySelectorAll('.view-toggle__button');
      buttons.forEach(button => {
        button.addEventListener('click', (e) => {
          const target = e.currentTarget as HTMLButtonElement;
          const view = target.dataset.view as 'processed' | 'source';
          this.switchView(view);
        });
      });

      // Handle keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        // Shift+P for processed view
        if (e.shiftKey && e.key === 'P') {
          e.preventDefault();
          this.switchView('processed');
        }
        // Shift+S for source view
        else if (e.shiftKey && e.key === 'S') {
          e.preventDefault();
          this.switchView('source');
        }
      });

      // Sync with URL query params on page load
      this.syncFromUrl();
    }

    private switchView(view: 'processed' | 'source') {
      if (this.currentView === view) return;

      this.currentView = view;

      // Update localStorage
      localStorage.setItem('nh:viewMode', view);

      // Update URL
      const url = new URL(window.location.href);

      if (view === 'source') {
        url.pathname = `/daily/${this.currentDate}/source/`;
        url.searchParams.delete('view'); // Remove view param from source URL
      } else {
        url.pathname = `/daily/${this.currentDate}/`;
        url.searchParams.delete('view'); // Clean URL for processed view (default)
      }

      // Navigate to new view
      window.location.href = url.toString();
    }

    private syncFromUrl() {
      const params = new URLSearchParams(window.location.search);
      const viewParam = params.get('view') as 'processed' | 'source' | null;

      if (viewParam && viewParam !== this.currentView) {
        this.currentView = viewParam;
        localStorage.setItem('nh:viewMode', viewParam);
      }
    }
  }

  // Initialize all view toggles on the page
  document.addEventListener('DOMContentLoaded', () => {
    const toggles = document.querySelectorAll('.view-toggle');
    toggles.forEach(toggle => {
      new ViewToggleManager(toggle as HTMLElement);
    });
  });
</script>

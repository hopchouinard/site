# WARP.md

This file provides guidance to WARP (warp.dev) when working with code in this repository.

## Project Overview

This is the **static site frontend** for NeuroHelix, built with Astro v5 and Tailwind CSS v4. It displays AI intelligence dashboards generated by the parent NeuroHelix pipeline.

**Key characteristics:**
- Consumes data from parent project's `../data/publishing/*.json` directory
- Two-phase build: prebuild scripts → Astro build
- Astro content collections for type-safe dashboard data
- MiniSearch-powered search index built during prebuild
- Static site generation with directory-based URLs
- Deployed to Cloudflare Pages

## Essential Commands

All commands use `pnpm` and are run from the `site/` directory:

```bash
# Development server (http://localhost:4321)
pnpm dev

# Full build (runs prebuild → build)
pnpm build

# Preview production build locally
pnpm preview

# Run prebuild scripts only (manual testing)
node scripts/ingest.mjs
node scripts/build-search-index.mjs

# Astro CLI commands
pnpm astro --help
pnpm astro check        # Type checking
pnpm astro add <integration>
```

## High-Level Architecture

### Two-Phase Build Pipeline

The build process has two distinct phases controlled by `package.json`:

**Phase 1: Prebuild (Data Ingestion)**
```bash
node scripts/ingest.mjs && node scripts/build-search-index.mjs
```

**Phase 2: Astro Build**
```bash
astro build
```

This separation is critical because Astro's content collections require markdown files to exist **before** the build starts.

### Data Flow Architecture

```
Parent Directory:
  ../data/publishing/*.json
       ↓
  scripts/ingest.mjs
       ↓ (transforms to markdown with frontmatter)
  src/content/dashboards/*.md
       ↓ (Astro Content Collections)
  Static Site Generation
       ↓
  dist/
```

Parallel to this, the search index is built:

```
  ../data/publishing/*.json
       ↓
  scripts/build-search-index.mjs
       ↓ (uses MiniSearch)
  public/search-index.json
  public/search-index.json.gz (if >2MB)
       ↓
  Copied to dist/ during Astro build
```

### Prebuild Scripts Explained

**1. `scripts/ingest.mjs`**

Purpose: Converts JSON dashboard data to Astro content collection format

- **Input:** `../../data/publishing/*.json` (parent directory)
- **Output:** 
  - `src/content/dashboards/*.md` (one per dashboard)
  - `src/data/tags.json` (aggregated tags)
- **Behavior:**
  - Creates markdown files with YAML frontmatter
  - Validates against content collection schema
  - Gracefully handles missing data directory
  - Idempotent: safe to run multiple times

**2. `scripts/build-search-index.mjs`**

Purpose: Builds MiniSearch index for client-side search functionality

- **Input:** `../../data/publishing/*.json`
- **Output:** 
  - `public/search-index.json`
  - `public/search-index.json.gz` (compressed, if >2MB)
- **Index Configuration:**
  - Fields: `date`, `title`, `summary`, `tags`, `full_text`
  - Store fields: `date`, `title`, `summary`, `permalink`, `tags`
  - Boost: `title: 2`, `tags: 1.5`
  - Fuzzy search: 0.2
- **Behavior:**
  - Combines summary, sections, implications into `full_text`
  - Auto-compresses if size exceeds 2MB
  - Creates empty index if no data exists

### Astro Content Collections

**Schema Definition:** `src/content/config.ts`

The `dashboards` collection validates incoming data with Zod:

```typescript
{
  date: string
  generated: string
  domains_count: number
  title: string
  summary: string
  tags: array<string>
  categories: array<string>
  sections: array<{heading, content}>
  notable_developments: array<string>
  strategic_implications: string
  recommendations: array<string>
  permalink: string
}
```

**Critical:** The prebuild scripts must generate markdown that matches this schema exactly, or Astro build will fail.

### Dynamic Routing

**Two pages:**

1. **`src/pages/index.astro`**
   - Lists all dashboards
   - Sorted by date (newest first)
   - Uses `getCollection('dashboards')`

2. **`src/pages/dashboards/[date].astro`**
   - Dynamic route for individual dashboards
   - Uses `getStaticPaths()` to generate routes at build time
   - Each dashboard gets URL: `/dashboards/YYYY-MM-DD/`
   - Renders content with `dashboard.render()`

### Styling with Tailwind CSS v4

**Configuration approach:**
- No separate `tailwind.config.js` file
- Theme defined in `src/styles/global.css` using `@theme` directive
- Custom properties:
  - `--color-background: #1a1a1a`
  - `--color-primary: #8b5cf6` (purple/violet)
  - `--color-neutral: #f4f4f5`
  - `--color-neutral-dark: #94a3b8`
- Integrated via `@tailwindcss/vite` plugin in `astro.config.mjs`

## Important Implementation Details

### Prebuild Dependency Chain

The prebuild scripts must run **before** `astro build` because:

1. Astro's build step performs content collection validation at startup
2. If markdown files don't exist, Astro fails immediately
3. Search index needs to be in `public/` before build starts

**Manual workflow for testing:**
```bash
# 1. Generate dashboard data in parent directory
cd .. && ./scripts/orchestrator.sh

# 2. Run prebuild scripts
cd site
node scripts/ingest.mjs
node scripts/build-search-index.mjs

# 3. Run Astro build
pnpm build
```

### Data Directory Relationship

This site depends on the **parent NeuroHelix project** generating data:

- Parent pipeline outputs: `../data/publishing/*.json`
- Site consumes: these JSON files during prebuild
- If parent pipeline hasn't run, prebuild scripts create empty placeholders

**Development consideration:** When developing the site, ensure parent pipeline has generated at least one dashboard, or the site will show "No dashboards available."

### Astro Configuration (`astro.config.mjs`)

```javascript
{
  output: 'static',           // Static site generation
  base: '/',                  // Root URL path
  build: {
    format: 'directory'       // URLs like /dashboards/2024-01-01/ not .html
  },
  site: 'https://neurohelix.patchoutech.com',
  vite: {
    plugins: [tailwindcss()]  // Tailwind v4 integration
  }
}
```

**Directory format** means:
- Each page becomes a directory with `index.html`
- Clean URLs without `.html` extensions
- Better for SEO and user experience

### MiniSearch Integration

The search index is built server-side but used client-side:

1. **Build time:** `build-search-index.mjs` creates index
2. **Runtime:** Client fetches `search-index.json`
3. **Search:** MiniSearch hydrates from JSON and performs searches

**Index size management:**
- Uncompressed: served to modern browsers
- Gzipped: automatically served by Cloudflare if browser supports it
- Threshold: 2MB triggers compression

### Static Generation Specifics

- **Build output:** `dist/` directory
- **No server-side rendering:** All pages pre-generated at build time
- **Client-side interactivity:** Can be added via Astro islands (not currently used)
- **Deployment:** Designed for Cloudflare Pages (wrangler devDependency)

## Development Workflow

### Full Development Cycle

```bash
# 1. Ensure parent pipeline has generated data
cd ..
./scripts/orchestrator.sh
cd site

# 2. Start dev server (watches for changes)
pnpm dev

# 3. Make changes to components, layouts, pages
# Dev server hot-reloads automatically

# 4. If data schema changes, re-run prebuild
node scripts/ingest.mjs

# 5. Build for production
pnpm build

# 6. Preview production build
pnpm preview
```

### Working with Content

**Adding new dashboard data:**
1. Add JSON file to `../data/publishing/` (handled by parent pipeline)
2. Run `node scripts/ingest.mjs` to convert to markdown
3. Astro dev server picks up new content automatically

**Modifying dashboard schema:**
1. Update `src/content/config.ts` Zod schema
2. Update `scripts/ingest.mjs` to generate matching frontmatter
3. Re-run prebuild and check for validation errors

**Testing with mock data:**
- Manually create JSON in `../data/publishing/`
- Must match expected structure (see existing files as template)
- Run prebuild scripts to validate

### When to Run Prebuild Scripts

**Automatic:** `pnpm build` always runs prebuild first

**Manual:** Run individually when:
- Testing ingestion logic changes
- Debugging schema validation errors
- Verifying search index generation
- Working on prebuild script modifications

**Not needed:** During `pnpm dev` unless:
- Content collection schema changed
- New data added to parent directory
- Search functionality being tested

### Important Gotchas

**1. Missing Parent Data Directory**
- Symptom: Site shows "No dashboards available"
- Cause: `../data/publishing/` empty or doesn't exist
- Solution: Run parent pipeline first: `cd .. && ./scripts/orchestrator.sh`

**2. Schema Validation Failures**
- Symptom: Astro build fails with Zod validation errors
- Cause: Ingest script generates invalid frontmatter
- Solution: Check `src/content/config.ts` matches `scripts/ingest.mjs` output

**3. Search Index Not Working**
- Symptom: Search returns no results
- Cause: Index not built or corrupted
- Solution: Delete `public/search-index.json*` and rebuild

**4. Dev Server Not Picking Up New Content**
- Symptom: New dashboards don't appear in dev mode
- Cause: Ingest script not run since adding new data
- Solution: Run `node scripts/ingest.mjs` then restart dev server

**5. Tailwind Styles Not Applying**
- Symptom: Custom theme colors not working
- Cause: Tailwind v4 theme syntax differs from v3
- Solution: Use `@theme` directive in CSS, not `tailwind.config.js`

### Deployment Considerations

**Cloudflare Pages:**
- Build command: `pnpm build`
- Output directory: `dist`
- Node version: 18+ (check `.nvmrc` if exists)
- Environment variables: None currently required

**Pre-deployment checklist:**
1. Ensure parent pipeline has generated current data
2. Run full build locally: `pnpm build`
3. Test production preview: `pnpm preview`
4. Verify search index generated: `ls -lh public/search-index.json*`
5. Check build output size: `du -sh dist/`

## Relationship to Parent Project

This site is a **subdirectory** of the larger NeuroHelix project:

- **Parent:** `/Users/pchouinard/Dev/NeuroHelix/`
- **This site:** `/Users/pchouinard/Dev/NeuroHelix/site/`

**Parent project handles:**
- Gemini CLI orchestration
- Research prompt execution
- Daily report aggregation
- HTML dashboard generation (separate from this Astro site)
- LaunchD/cron automation

**This site handles:**
- Modern web frontend for dashboards
- Search functionality
- Responsive design
- Static hosting optimization

**See parent `WARP.md`** for information about:
- Running the daily pipeline
- Configuring research prompts
- Understanding LaunchD automation
- Troubleshooting Gemini CLI
